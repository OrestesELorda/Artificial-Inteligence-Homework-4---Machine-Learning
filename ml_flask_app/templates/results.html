<!-- templates/results.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ML Analysis - Results</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
  <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
</head>
<body>
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">
      <i class="bi bi-bar-chart-line text-primary"></i> Analysis Results
    </h1>
    <a href="{{ url_for('index') }}" class="btn btn-secondary">
      <i class="bi bi-arrow-left"></i> New Analysis
    </a>
  </div>

  <section class="mt-4">
    <h4><i class="bi bi-funnel"></i> Preprocessing Summary</h4>
    <div class="card">
      <div class="card-body">
        <pre>{{ results.preprocess_summary | tojson(indent=2) }}</pre>
      </div>
    </div>
  </section>

  <section class="mt-4">
    <h4><i class="bi bi-diagram-3"></i> Clustering Analysis</h4>
    <div class="alert alert-info mb-4">
      <i class="bi bi-info-circle"></i> 
      <strong>Optimal Clusters:</strong> Auto-detected k = <strong class="badge bg-primary">{{ results.auto_k }}</strong> 
      — Using k = <strong class="badge bg-success">{{ results.used_k }}</strong>
    </div>
    <div class="row">
      <div class="col-md-6">
        <h6>Elbow curve</h6>
        <img src="{{ url_for('result_file', filename=results.elbow_plot) }}" class="img-fluid" alt="Elbow">
      </div>
      <div class="col-md-6">
        <h6>Cluster scatter (price vs units_sold)</h6>
        <img src="{{ url_for('result_file', filename=results.cluster_scatter_plot) }}" class="img-fluid" alt="clusters">
      </div>
    </div>

    <h6 class="mt-3"><i class="bi bi-pie-chart"></i> Cluster Analysis and Interpretation</h6>
    {% for row in results.cluster_stats %}
    <div class="card mb-3" data-cluster="{{ row.cluster }}">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="bi bi-circle-fill" style="font-size: 0.5rem;"></i> 
          Cluster {{ row.cluster }}: "{{ row.cluster_name }}"
        </h5>
      </div>
      <div class="card-body">
        <div class="stats-grid mb-4">
          <div class="stat-card">
            <div class="stat-value">{{ row.n_products }}</div>
            <div class="stat-label">Products</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${{ "{:.2f}".format(row.price) }}</div>
            <div class="stat-label">Avg Price</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">{{ "{:.0f}".format(row.units_sold) }}</div>
            <div class="stat-label">Avg Units Sold</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${{ "{:.2f}".format(row.profit) }}</div>
            <div class="stat-label">Avg Profit</div>
          </div>
        </div>
        <div class="alert alert-info mb-3">
          <i class="bi bi-tag"></i> <strong>Characteristics:</strong> {{ row.characteristics }}
        </div>
        <div class="alert alert-success mb-0">
          <i class="bi bi-lightbulb"></i> <strong>Business Insight:</strong> {{ row.business_insight }}
        </div>
      </div>
    </div>
    {% endfor %}
    
    <h6 class="mt-4"><i class="bi bi-table"></i> Cluster Statistics Summary</h6>
    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm table-bordered">
      <thead>
        <tr>
          <th>Cluster</th>
          <th>Name</th>
          <th>n_products</th>
          <th>avg_price</th>
          <th>avg_units_sold</th>
          <th>avg_profit</th>
          <th>avg_promotion_frequency</th>
        </tr>
      </thead>
      <tbody>
      {% for row in results.cluster_stats %}
        <tr>
          <td>{{ row.cluster }}</td>
          <td>{{ row.cluster_name }}</td>
          <td>{{ row.n_products }}</td>
          <td>{{ "{:.3f}".format(row.price) }}</td>
          <td>{{ "{:.3f}".format(row.units_sold) }}</td>
          <td>{{ "{:.3f}".format(row.profit) }}</td>
          <td>{{ "{:.3f}".format(row.promotion_frequency) }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
        </div>
      </div>
    </div>
  </section>

  <section class="mt-4">
    <h4><i class="bi bi-graph-up"></i> Regression Analysis - Predicting {{ results.target }}</h4>
    
    <h6 class="mt-3"><i class="bi bi-trophy"></i> Model Comparison and Evaluation</h6>
    <div class="card mb-3">
      <div class="card-body">
        <h6><i class="bi bi-speedometer2"></i> Performance Metrics</h6>
        <div class="table-responsive">
          <table class="table table-sm table-bordered">
          <thead>
            <tr>
              <th>Model</th>
              <th>MSE (Test)</th>
              <th>MAE (Test)</th>
              <th>MSE (Train)</th>
            </tr>
          </thead>
          <tbody>
          {% for model, m in results.regression_metrics.items() %}
            <tr {% if model == results.comparison_analysis.best_model_key %}class="table-success"{% endif %}>
              <td><strong>{{ model }}</strong>{% if model == results.comparison_analysis.best_model_key %} ⭐ Best{% endif %}</td>
              <td>{{ "{:.4f}".format(m.MSE) }}</td>
              <td>{{ "{:.4f}".format(m.MAE) }}</td>
              <td>{{ "{:.4f}".format(m.MSE_train) }}</td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
        </div>
        
        <div class="alert alert-success mt-4">
          <h6 class="mb-2">
            <i class="bi bi-trophy-fill"></i> Best Model: {{ results.comparison_analysis.best_model }}
          </h6>
          <p class="mb-0"><strong>Why this model performs better:</strong></p>
          <p class="mb-0">{{ results.comparison_analysis.why_better }}</p>
        </div>
        
        <h6 class="mt-4"><i class="bi bi-shield-check"></i> Overfitting Analysis</h6>
        <div class="row">
          {% for model_name, analysis in results.comparison_analysis.overfitting_analysis.items() %}
          <div class="col-md-6">
            <div class="card mb-2">
              <div class="card-body">
                <h6>{{ model_name }}</h6>
                <ul class="small">
                  <li>Train MSE: {{ "{:.4f}".format(analysis.train_mse) }}</li>
                  <li>Test MSE: {{ "{:.4f}".format(analysis.test_mse) }}</li>
                  <li>Test/Train Ratio: {{ "{:.2f}".format(analysis.ratio) }}</li>
                  <li><strong>Assessment:</strong> {{ analysis.assessment }}</li>
                </ul>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        
        <h6 class="mt-4"><i class="bi bi-balance-scale"></i> Model Tradeoffs</h6>
        <div class="row">
          {% for model_name, tradeoffs in results.comparison_analysis.tradeoffs.items() %}
          <div class="col-md-6">
            <div class="card mb-2">
              <div class="card-body">
                <h6>{{ model_name }}</h6>
                <p class="mb-1"><strong>Pros:</strong></p>
                <ul class="small">
                  {% for pro in tradeoffs.pros %}
                  <li>{{ pro }}</li>
                  {% endfor %}
                </ul>
                <p class="mb-1"><strong>Cons:</strong></p>
                <ul class="small">
                  {% for con in tradeoffs.cons %}
                  <li>{{ con }}</li>
                  {% endfor %}
                </ul>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    
    <h6 class="mt-4"><i class="bi bi-image"></i> Visualizations</h6>
    <div class="row g-4">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0">
              <i class="bi bi-scatter-chart"></i> Actual vs Predicted ({{ results.comparison_analysis.best_model }})
            </h6>
          </div>
          <div class="card-body">
            <img src="{{ url_for('result_file', filename=results.regression_plot) }}" class="img-fluid" alt="regression">
            <p class="small text-muted mt-3 mb-0">
              <i class="bi bi-info-circle"></i> Points should cluster around the diagonal red line for good predictions.
            </p>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0">
              <i class="bi bi-graph-down"></i> Residual Plot ({{ results.comparison_analysis.best_model }})
            </h6>
          </div>
          <div class="card-body">
            <img src="{{ url_for('result_file', filename=results.residual_plot) }}" class="img-fluid" alt="residuals">
            <p class="small text-muted mt-3 mb-0">
              <i class="bi bi-info-circle"></i> Residuals should be randomly distributed around zero with no clear patterns.
            </p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="mt-4">
    <h4><i class="bi bi-table"></i> Data Preview</h4>
    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          {{ results.preview_html|safe }}
        </div>
      </div>
    </div>
  </section>

  <div class="mt-5 text-center">
    <a href="{{ url_for('index') }}" class="btn btn-primary btn-lg">
      <i class="bi bi-arrow-clockwise"></i> Run Another Analysis
    </a>
  </div>
</div>
</body>
</html>
